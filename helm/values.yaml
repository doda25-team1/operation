# application config
app:
  name: sms-app
  version: v1
  replicaCount: 2
  
  # Docker image settings
  image:
    repository: ghcr.io/doda25-team1/app
    tag: latest # version to be used
    pullPolicy: IfNotPresent # only if not already downloaded
  
  # Network settings for the app
  service:
    type: ClusterIP # only accessible within the cluster
    port: 8080 # port other services talk to
    targetPort: 8080 # port app listens to
    portName: http-web # port name for istio
  
  # Resource limitations
  resources:
    limits:
      cpu: 500m # 0.5 CPU cores
      memory: 512Mi # 512 megabytes of RAM
    # minimums
    requests:
      cpu: 250m # 0.25 CPU cores
      memory: 256Mi # 256 megabytes of RAM
  
  # Access the app from outside the cluster
  ingress:
    enabled: true
    className: "nginx"
    hostname: "sms-app.example.com" # url on which app is accessible
    annotations: {}
    tls:
      enabled: false
      secretName: ""

  # ConfigMap for non-sensitive configuration
  config:
    enabled: false # Set to true to enable ConfigMap
    value: "example-config-value" # Placeholder configuration value

  # Secret for sensitive data (e.g., SMTP passwords)
  secret:
    enabled: false # Set to true to enable Secret
    smtpPassword: "changeme" # Placeholder - change during installation

  prometheus:
    serviceMonitor:
      enabled: true
      interval: 30s
    releaseLabel: sms-app-prom
    
modelService:
  name: sms-model-service
  replicaCount: 1

  image:
    repository: ghcr.io/doda25-team1/model-service
    tag: latest
    pullPolicy: IfNotPresent

  service:
    type: ClusterIP
    port: 8081
    targetPort: 8081
  
  env:
    MODEL_VERSION: "0.0.1"
    MODEL_BASE_URL: "https://github.com/doda25-team1/model-service/releases/download"

  volume:
    enabled: true
    mountPath: /app/output

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

persistence:
  enabled: false  # Disabled for testing - /mnt/shared doesn't exist on nodes
  storageType: hostPath
  hostPath:
    path: /mnt/shared
  accessModes: ReadWriteMany
  size: 1Gi
  storageClass: manual

monitoring:
  enabled: false  # Disabled - Prometheus Operator CRDs not installed

  prometheus:
    enabled: true
    replicaCount: 1
    retention: 24h
    scrapeInterval: 30s
    evaluationInterval: 30s
    serviceAccount:
      create: true
      name: ""
    service:
      type: ClusterIP
      port: 9090
    storage:
      enabled: false
      size: 2Gi
    resources: {}

  alertmanager:
    enabled: true
    replicaCount: 1
    service:
      type: ClusterIP
      port: 9093
    config:
      receiver: default
      webhookUrl: ""
    email:
      enabled: false
      receiver: email
      to: you@example.com
      from: alerts@example.com
      smarthost: smtp.example.com:587
      requireTls: true
      username: alerts@example.com
      password: "" # set via Helm value; stored in a Secret and mounted into Alertmanager
    resources: {}

  rules:
    requestRate:
      enabled: true
      thresholdPerMinute: 15
      for: 2m
      severity: warning

  grafana:
    enabled: true
    replicaCount: 1

    image:
      repository: grafana/grafana
      tag: "10.2.0"
      pullPolicy: IfNotPresent

    service:
      type: ClusterIP
      port: 3000

    adminPassword: adminPassword

    datasources:
      enabled: true
      prometheusUrl: "http://{{ .Release.Name }}-doda-sms-app-prometheus:9090"

    dashboards:
      enabled: true

    resources:
      limits:
        cpu: 200m
        memory: 256Mi
      requests:
        cpu: 100m
        memory: 128Mi

# Istio Service Mesh Configuration
istio:
  enabled: true # enable/disable Istio resources (Istio is installed during cluster provisioning)

  # Traffic split configuration for canary releases
  trafficSplit:
    stable: 90 # Percentage of traffic to v1 (stable version)
    experiment: 10 # Percentage of traffic to v2 (experiment version)

  # Sticky session configuration using consistent hashing
  stickySession:
    headerName: "x-user-id" # Header used for consistent hashing

  # Gateway configuration - controls how external traffic enters the mesh
  gateway:
    enabled: true # Set to true to route traffic through Istio Gateway
    # Gateway resource references the existing IngressGateway (installed during provisioning)
    name: "istio-ingressgateway" # Name of the gateway (can be overwritten for different clusters)
    namespace: "istio-system" # Namespace where IngressGateway is deployed
    # Selector to match the IngressGateway pods
    selector:
      istio: ingressgateway
    # Port configuration
    port:
      number: 80
      name: http
      protocol: HTTP
    # Host to match in VirtualService
    host: "*" # Accept all hosts, or specify like "sms-app.example.com"

  rateLimit:
    enabled: true
    maxTokens: 10
    tokensPerFill: 10
    fillInterval: 60s