---
- name: Controller-specific configuration
  hosts: ctrl
  become: true

  vars:
    ssh_user: vagrant

  tasks:
    # Step 13: Init cluster
    - name: Check if Kubernetes cluster is already initialized
      ansible.builtin.stat:
        path: /etc/kubernetes/admin.conf
      register: kube_admin_conf

    - name: Initialize Kubernetes control plane with kubeadm
      ansible.builtin.command: >
        kubeadm init
        --apiserver-advertise-address={{ controller_ip }}
        --node-name ctrl
        --pod-network-cidr={{ pod_network_cidr }}
      when: not kube_admin_conf.stat.exists

    - name: Verify that admin.conf exists after initialization
      ansible.builtin.stat:
        path: /etc/kubernetes/admin.conf
      register: kube_admin_conf

    # Step 14: Setup kubectl
    - name: Ensure .kube directory exists for vagrant user
      ansible.builtin.file:
        path: "/home/{{ ssh_user }}/.kube"
        state: directory
        owner: "{{ ssh_user }}"
        group: "{{ ssh_user }}"
        mode: "0700"
      when: kube_admin_conf.stat.exists

    - name: Copy admin kubeconfig for vagrant user
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ ssh_user }}/.kube/config"
        owner: "{{ ssh_user }}"
        group: "{{ ssh_user }}"
        mode: "0600"
        remote_src: true
      when: kube_admin_conf.stat.exists

    - name: Ensure .kube directory exists in shared /vagrant folder
      ansible.builtin.file:
        path: /vagrant/.kube
        state: directory
        mode: "0700"
      when: kube_admin_conf.stat.exists

    - name: Copy admin kubeconfig to shared /vagrant folder for host use
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: /vagrant/.kube/config
        mode: "0644"
        remote_src: true
      when: kube_admin_conf.stat.exists

    # Step 15: Setup flannel
    - name: Download Flannel manifest
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/flannel-io/flannel/v0.26.7/Documentation/kube-flannel.yml
        dest: /tmp/kube-flannel.yml

    - name: Patch Flannel to use eth1 (Host-only network)
      ansible.builtin.replace:
        path: /tmp/kube-flannel.yml
        regexp: '(- --kube-subnet-mgr)'
        replace: '\1\n        - --iface=eth1'

    - name: Apply Flannel manifest
      ansible.builtin.command: kubectl apply -f /tmp/kube-flannel.yml
      become_user: vagrant

    # Step 16: Setup Helm
    - name: Add Helm GPG key
      ansible.builtin.get_url:
        url: https://packages.buildkite.com/helm-linux/helm-debian/gpgkey
        dest: /etc/apt/keyrings/helm.asc
        mode: '0644'

    - name: Add Helm repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/helm.asc] https://packages.buildkite.com/helm-linux/helm-debian/any/ any main"
        state: present
        filename: helm-stable-debian

    - name: Install Helm
      ansible.builtin.apt:
        name: helm
        update_cache: yes

    # Step 17: Setup Helm-Diff
    - name: Check installed helm plugins
      ansible.builtin.command: helm plugin list
      become_user: vagrant
      register: helm_plugins
      changed_when: false 

    - name: Install helm-diff plugin
      ansible.builtin.command: helm plugin install https://github.com/databus23/helm-diff
      become_user: vagrant
      when: "'diff' not in helm_plugins.stdout"

    # Install pip3
    - name: Install python3-pip
      ansible.builtin.apt:
        name: python3-pip
        state: present
        update_cache: yes

    # Install Python Kubernetes library for Ansible kubernetes.core modules (temporary?)
    - name: Install Python kubernetes library
      ansible.builtin.pip:
        name: kubernetes
        state: present
        executable: pip3
        break_system_packages: yes