---
- hosts: ctrl
  become: true
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf

  tasks:
    - name: Install MetalLB Manifest
      ansible.builtin.shell: kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.9/config/manifests/metallb-native.yaml

    - name: Wait for MetalLB Controller to be ready
      ansible.builtin.shell: |
        kubectl wait -n metallb-system \
        -l app=metallb,component=controller \
        --for=condition=ready pod \
        --timeout=60s
      register: result
      retries: 5
      delay: 10
      until: result.rc == 0

    - name: Create MetalLB Configuration File
      copy:
        dest: /root/metallb-config.yaml
        content: |
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: default-pool
            namespace: metallb-system
          spec:
            addresses:
            - 192.168.56.90-192.168.56.99
          ---
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            name: default-advertisement
            namespace: metallb-system

    - name: Apply MetalLB Configuration
      ansible.builtin.shell: kubectl apply -f /root/metallb-config.yaml

    - name: Add Ingress-NGINX Helm repository
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: https://kubernetes.github.io/ingress-nginx


    - name: Ensure ingress-nginx namespace exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: ingress-nginx


    - name: Install Ingress-NGINX via Helm
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: ingress-nginx
        create_namespace: false
        state: present
        values:
          controller:
            service:
              type: LoadBalancer
              # Uncomment if we want the LoadBalancer to have a specific IP
              loadBalancerIP: "192.168.56.95" # Fixed IP for ingress


    - name: Wait for ingress controller to become ready
      ansible.builtin.shell: |
        kubectl wait --namespace ingress-nginx \
        --for=condition=ready pod \
        -l app.kubernetes.io/component=controller \
        --timeout=120s


    # ============ Istio Installation ============
    - name: Check if Istio is already installed
      ansible.builtin.shell: kubectl get namespace istio-system
      register: istio_namespace
      failed_when: false
      changed_when: false

    - name: Detect system architecture
      ansible.builtin.shell: uname -m
      register: system_arch
      changed_when: false

    - name: Set Istio architecture variable
      ansible.builtin.set_fact:
        istio_arch: "{{ 'arm64' if system_arch.stdout == 'aarch64' else 'amd64' }}"

    - name: Download Istio for correct architecture
      ansible.builtin.unarchive:
        src: "https://github.com/istio/istio/releases/download/1.24.2/istio-1.24.2-linux-{{ istio_arch }}.tar.gz"
        dest: /tmp/
        remote_src: yes
        creates: /tmp/istio-1.24.2
      when: istio_namespace.rc != 0

    - name: Install istioctl binary
      ansible.builtin.copy:
        src: /tmp/istio-1.24.2/bin/istioctl
        dest: /usr/local/bin/istioctl
        mode: '0755'
        remote_src: yes
      when: istio_namespace.rc != 0

    - name: Install Istio with demo profile
      ansible.builtin.shell: |
        export PATH=/usr/local/bin:$PATH
        istioctl install --set profile=demo -y
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      when: istio_namespace.rc != 0

    - name: Wait for Istio control plane to be ready
      ansible.builtin.shell: |
        kubectl wait --namespace istio-system \
        --for=condition=ready pod \
        -l app=istiod \
        --timeout=300s
      when: istio_namespace.rc != 0

    - name: Enable Istio sidecar injection for default namespace
      ansible.builtin.shell: kubectl label namespace default istio-injection=enabled --overwrite

    - name: Verify Istio IngressGateway is deployed
      ansible.builtin.shell: |
        kubectl get service istio-ingressgateway -n istio-system
      register: istio_gateway
      retries: 10
      delay: 10
      until: istio_gateway.rc == 0

    - name: Display Istio installation status
      ansible.builtin.debug:
        msg: "Istio has been successfully installed and configured"


    - name: Add Kubernetes Dashboard Helm repo
      kubernetes.core.helm_repository:
        name: kubernetes-dashboard
        repo_url: https://kubernetes.github.io/dashboard/


    - name: Install Kubernetes Dashboard
      kubernetes.core.helm:
        name: kubernetes-dashboard
        chart_ref: kubernetes-dashboard/kubernetes-dashboard
        release_namespace: kubernetes-dashboard
        create_namespace: true
        state: present
        values:
          service:
            type: LoadBalancer
          ingress:
            enabled: true
            className: "nginx"
            hosts:
              - host: dashboard.local
                paths:
                  - path: /
                    pathType: Prefix
            annotations:
              nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"


    - name: Create admin-user ServiceAccount
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: admin-user
            namespace: kubernetes-dashboard


    - name: Create admin-user ClusterRoleBinding
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: admin-user
          subjects:
            - kind: ServiceAccount
              name: admin-user
              namespace: kubernetes-dashboard
          roleRef:
            kind: ClusterRole
            name: cluster-admin
            apiGroup: rbac.authorization.k8s.io

    - name: Create Ingress for Dashboard
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: kubernetes-dashboard
            namespace: kubernetes-dashboard
            annotations:
              nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
          spec:
            ingressClassName: nginx
            rules:
            - host: dashboard.local
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: kubernetes-dashboard-kong-proxy
                      port:
                        number: 443

    - name: Wait for dashboard pods
      ansible.builtin.shell: |
        kubectl wait --namespace kubernetes-dashboard \
          --for=condition=ready pod \
          -l app.kubernetes.io/instance=kubernetes-dashboard \
          --timeout=120s